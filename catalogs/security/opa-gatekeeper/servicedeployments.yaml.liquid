apiVersion: deployments.plural.sh/v1alpha1
kind: ServiceDeployment
metadata:
  name: opa-gatekeeper-{{ context.cluster }}
  namespace: apps
spec:
  namespace: policy
  git:
    folder: helm/opa-gatekeeper
    ref: main
  repositoryRef:
    kind: GitRepository
    name: infra
    namespace: infra
  helm:
    version: 3.15.1
    chart: gatekeeper
    repository:
      name: gatekeeper
      namespace: apps
  configuration:
    cluster: {{ context.cluster }}
  clusterRef:
    kind: Cluster
    name: {{ context.cluster }}
    namespace: infra
---
apiVersion: deployments.plural.sh/v1alpha1
kind: ServiceDeployment
metadata:
  name: opa-constraints-{{ context.cluster }}
  namespace: apps
spec:
  namespace: policy
  templated: false
  git:
    folder: resources/policy/constraints
    ref: main
  repositoryRef:
    kind: GitRepository
    name: bootstrap
    namespace: infra
  clusterRef:
    kind: Cluster
    name: {{ context.cluster }}
    namespace: infra
---
apiVersion: deployments.plural.sh/v1alpha1
kind: ServiceDeployment
metadata:
  name: policy-bundle-{{ context.cluster }}
  namespace: apps
spec:
  name: policy-bundle
  namespace: policy
  templated: false
  git:
    folder: resources/policy/bundles/{{ context.bundle }}
    ref: main
  kustomize:
    path: '.'
  repositoryRef:
    kind: GitRepository
    name: bootstrap
    namespace: infra
  clusterRef:
    kind: Cluster
    name: {{ context.cluster }}
    namespace: infra
